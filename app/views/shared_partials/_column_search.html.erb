<%= form_tag path, method: :get, class: "mb-4" do %>
  <div id="search-fields">
    <% if params[:search_column].present? %>
      <% params[:search_column].each_with_index do |column, index| %>
        <div class="row g-3 align-items-end mb-3">
          <div class="col-md-4">
            <%= select_tag "search_column[]", 
                options_for_select(@column_groups.flatten, column), 
                class: "form-select",
                prompt: "Select Column to Search" %>
          </div>
          <div class="col-md-3">
            <%= text_field_tag "search_term[]", params[:search_term][index], 
                class: "form-control",
                placeholder: "Enter search term..." %>
          </div>
          <div class="col-md-2">
            <%= text_field_tag "exclude_term[]", params[:exclude_term]&.[](index), 
                class: "form-control",
                placeholder: "Enter exclude term..." %>
          </div>
          <div class="col-md-1">
            <div class="d-flex align-items-center">
              <%= hidden_field_tag "exclude_empty[#{index}]", "0", id: "exclude_empty_hidden_#{index}" %>
              <%= check_box_tag "exclude_empty[#{index}]", "1", params[:exclude_empty]["#{index}"] == "1", 
                  class: "form-check-input me-1",
                  onclick: "toggleHiddenInput(this, #{index})" %>
              <label class="form-check-label mb-0">Exclude Empty</label>
            </div>
          </div>
          <div class="col-md-2">
            <% if index == 0 %>
              <button type="button" class="btn btn-secondary w-100" onclick="addSearchField()">
                Add Field
              </button>
            <% else %>
              <button type="button" class="btn btn-danger w-100" onclick="this.closest('.row').remove()">
                Remove
              </button>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="row g-3 align-items-end mb-3">
        <div class="col-md-4">
          <%= select_tag "search_column[]", 
              options_for_select(@column_groups.flatten, params[:search_column]&.first), 
              class: "form-select",
              prompt: "Select Column to Search" %>
        </div>
        <div class="col-md-3">
          <%= text_field_tag "search_term[]", params[:search_term]&.first, 
              class: "form-control",
              placeholder: "Enter search term..." %>
        </div>
        <div class="col-md-2">
          <%= text_field_tag "exclude_term[]", params[:exclude_term]&.first, 
              class: "form-control",
              placeholder: "Enter exclude term..." %>
        </div>
        <div class="col-md-1">
          <div class="d-flex align-items-center">
            <%= hidden_field_tag "exclude_empty[0]", "0", id: "exclude_empty_hidden_0" %>
            <%= check_box_tag "exclude_empty[0]", "1", params[:exclude_empty]&.first == "1", 
                class: "form-check-input me-1",
                onclick: "toggleHiddenInput(this, 0)" %>
            <label class="form-check-label mb-0">Exclude Empty</label>
          </div>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-secondary w-100" onclick="addSearchField()">
            Add Field
          </button>
        </div>
      </div>
    <% end %>
  </div>
  <div class="row">
    <div class="col-12">
      <%= submit_tag "Search", class: "btn btn-primary" %>
    </div>
  </div>
<% end %>

<script>
function toggleHiddenInput(checkbox, index) {
  const hiddenInput = document.getElementById(`exclude_empty_hidden_${index}`);
  if (checkbox.checked) {
    hiddenInput.disabled = true; // Prevent the hidden input from being submitted
  } else {
    hiddenInput.disabled = false; // Enable it back if unchecked
  }
}

function addSearchField() {
  const container = document.getElementById('search-fields');
  const index = container.children.length; // Calculate the index dynamically
  const newRow = document.createElement('div');
  newRow.className = 'row g-3 align-items-end mb-3';
  newRow.innerHTML = `
    <div class="col-md-4">
      <select name="search_column[]" class="form-select">
        <option value="">Select Column to Search</option>
        <%= @column_groups.flatten.map { |col| "<option value='#{col}'>#{col}</option>" }.join.html_safe %>
      </select>
    </div>
    <div class="col-md-3">
      <input type="text" name="search_term[]" class="form-control" placeholder="Enter search term...">
    </div>
    <div class="col-md-2">
      <input type="text" name="exclude_term[]" class="form-control" placeholder="Enter exclude term...">
    </div>
    <div class="col-md-1">
      <div class="d-flex align-items-center">
        <input type="hidden" name="exclude_empty[${index}]" value="0" id="exclude_empty_hidden_${index}">
        <input type="checkbox" name="exclude_empty[${index}]" value="1" class="form-check-input me-1" 
          onclick="toggleHiddenInput(this, ${index})">
        <label class="form-check-label mb-0">Exclude Empty</label>
      </div>
    </div>
    <div class="col-md-2">
      <button type="button" class="btn btn-danger w-100" onclick="this.closest('.row').remove()">
        Remove
      </button>
    </div>
  `;
  container.appendChild(newRow);
}
</script>
