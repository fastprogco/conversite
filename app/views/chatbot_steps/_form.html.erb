<div class="card">
  <div class="card-body">
    <%= form_with(url: @chatbot_step.id.present? ? chatbot_chatbot_step_path(@chatbot, @chatbot_step) : chatbot_chatbot_steps_path(@chatbot), local: true, class: "needs-validation") do |f| %>
      <% if @chatbot_step.id.present? %>
        <%= render "shared_partials/error", model: @chatbot_step %>
      <% end %>

      <div class="mb-3">
        <%= f.label :header, class: "form-label" %> <span class="text-danger">Max 60 characters</span>
        <%= f.text_field :header, class: "form-control", required: true, maxlength: 60, value: @chatbot_step.header %>
      </div>

      <div class="mb-3">
        <%= f.label :description, class: "form-label" %> <span class="text-danger">Max 1024 characters</span>
        <%= f.text_area :description, class: "form-control", rows: 5, required: true, maxlength: 1024, value: @chatbot_step.description %>
      </div>

      <div class="mb-3">
        <%= f.label :footer, class: "form-label" %> <span class="text-danger">Max 60 characters</span>
        <%= f.text_field :footer, class: "form-control", maxlength: 60, value: @chatbot_step.footer %>
      </div>

      <div class="mb-3">
        <%= f.label :list_button_caption, "List Button Caption", class: "form-label" %> <span class="text-danger">Max 20 characters</span>
        <%= f.text_field :list_button_caption, class: "form-control", maxlength: 20, value: @chatbot_step.list_button_caption %>
      </div>

      <% if @previous_chatbot_step_id.present? %>
        <%= f.hidden_field :previous_chatbot_step_id, value: @previous_chatbot_step_id %>
        <%= f.hidden_field :chatbot_button_reply_id, value: @chatbot_button_reply_id %>
      <% end %>

      <div class="mb-3">
        <%= f.submit class: "btn btn-primary" %>
        <% if request.path.include?('edit') %>
          <%= link_to "Add Reply Option", "#", class: "btn btn-info", data: { bs_toggle: "modal", bs_target: "#replyOptionModal" } %>
          <%= link_to "Add Multimedia Reply", "#", class: "btn btn-success", data: { bs_toggle: "modal", bs_target: "#multimediaReplyModal" } %>
          <%= link_to 'Add Location Reply', "#", class: "btn btn-warning", data: { bs_toggle: "modal", bs_target: "#locationReplyModal" } %>
          <%= link_to "Back", @previous_chatbot_step_id.present? ? edit_chatbot_chatbot_step_path(@chatbot, ChatbotStep.find(@previous_chatbot_step_id), params:{previous_chatbot_step_id: ChatbotStep.find(@previous_chatbot_step_id).previous_chatbot_step_id}) : chatbots_path, class: "btn btn-secondary" %>

          <% if @chatbot_step.chatbot_button_replies.where(is_deleted: false).any? %>
            <div class="table-responsive mt-3">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Order</th>
                    <th>Action Type</th>
                    <th>Added By</th>
                    <th>Added On</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @chatbot_step.chatbot_button_replies.where(is_deleted: false).order(:order).each do |reply| %>
                    <tr>
                      <td><%= reply.title %></td>
                      <td><%= reply.order %></td>
                      <td><%= reply.action_type_id.to_s.humanize %></td>
                      <td><%= reply.added_by&.email %></td>
                      <td><%= reply.added_on&.strftime("%Y-%m-%d %H:%M") %></td>
                      <td>
                        <%= link_to "Edit", edit_chatbot_chatbot_step_chatbot_button_reply_path(@chatbot, @chatbot_step, reply),
                            class: "btn btn-sm btn-warning" %>
                        <%= link_to "Delete", chatbot_chatbot_step_chatbot_button_reply_path(@chatbot, @chatbot_step, reply), 
                            data: { turbo_method: :delete, turbo_confirm: "Are you sure?" },
                            class: "btn btn-sm btn-danger" %>
                        <%= link_to "Next Step", ChatbotStep.find_by(chatbot_button_reply_id: reply.id).present? ? edit_chatbot_chatbot_step_path(@chatbot, ChatbotStep.find_by(chatbot_button_reply_id: reply.id), params:{previous_chatbot_step_id: @chatbot_step.id}) : new_chatbot_chatbot_step_path(@chatbot, params: { chatbot_button_reply_id: reply.id, previous_chatbot_step_id: @chatbot_step.id }),
                            class: "btn btn-sm btn-success" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<% if @chatbot_step.chatbot_multimedia_replies.where(is_deleted: false).any? %>
  <div class="table-responsive mt-3">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Media Type</th>
          <th>Order</th>
          <th>Text Body</th>
          <th>File Caption</th>
          <th>Added By</th>
          <th>Added On</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @chatbot_step.chatbot_multimedia_replies.includes(:added_by).where(is_deleted: false).order(:order).each do |reply| %>
          <tr>
            <td><%= reply.media_type_id.to_s.humanize %></td>
            <td><%= reply.order %></td>
            <td><%= reply.text_body %></td>
            <td><%= reply.file_caption %></td>
            <td><%= reply.added_by&.email %></td>
            <td><%= reply.added_on&.strftime("%Y-%m-%d %H:%M") %></td>
            <td>
              <%= link_to "Edit", edit_chatbot_chatbot_step_chatbot_multimedia_reply_path(@chatbot, @chatbot_step, reply),
                  class: "btn btn-sm btn-warning" %>
              <%= link_to "Delete", chatbot_chatbot_step_chatbot_multimedia_reply_path(@chatbot, @chatbot_step, reply),
                  data: { turbo_method: :delete, turbo_confirm: "Are you sure?" },
                  class: "btn btn-sm btn-danger" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<% if @chatbot_step.chatbot_location_replies.where(is_deleted: false).any? %>
  <div class="table-responsive mt-3">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Location Name</th>
          <th>Address</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Order</th>
          <th>Added By</th>
          <th>Added On</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @chatbot_step.chatbot_location_replies.where(is_deleted: false).order(:order).each do |reply| %>
          <tr>
            <td><%= reply.location_name %></td>
            <td><%= reply.location_address %></td>
            <td><%= reply.location_latitude %></td>
            <td><%= reply.location_longitude %></td>
            <td><%= reply.order %></td>
            <td><%= reply.added_by&.email %></td>
            <td><%= reply.added_on&.strftime("%Y-%m-%d %H:%M") %></td>
            <td>
              <%= link_to "Edit", edit_chatbot_chatbot_step_chatbot_location_reply_path(@chatbot, @chatbot_step, reply),
                  class: "btn btn-sm btn-warning" %>
              <%= link_to "Delete", chatbot_chatbot_step_chatbot_location_reply_path(@chatbot, @chatbot_step, reply, params: {chatbot: @chatbot, chatbot_step: @chatbot_step}),
                  data: { turbo_method: :delete, turbo_confirm: "Are you sure?" },
                  class: "btn btn-sm btn-danger" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>



<% if @chatbot_step.id.present? %>
  <%= render "chatbot_button_reply_modal", reply_title: "", reply_order: "", reply_action_type: "", reply_modal_id: "replyOptionModal", endpoint: nil %>
<% end %>
<% if @chatbot_step.id.present? %>
  <div class="modal fade" id="multimediaReplyModal" tabindex="-1" aria-labelledby="multimediaReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="multimediaReplyModalLabel">Add Multimedia Reply</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <%= render "chatbot_multimedia_replies/form", chatbot_multimedia_reply: ChatbotMultimediaReply.new %>
      </div>
    </div>
  </div>

  <div class="modal fade" id="locationReplyModal" tabindex="-1" aria-labelledby="locationReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="locationReplyModalLabel">Add Location Reply</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <%= render "chatbot_location_replies/form", chatbot_location_reply: ChatbotLocationReply.new %>
      </div>
    </div>
    </div>
<% end %>


